---
import type { InferGetStaticParamsType, InferGetStaticPropsType } from "astro";
import Layout from "../layouts/Layout.astro";
import Tags from "../components/Tags.astro";
import getPosts from "../lib/getPosts";
import Shadowbox from "../components/Shadowbox.astro";
import PostMeta from "../components/PostMeta.astro";
import Typography from "../components/Typography.astro";
import Comments from "../components/Comments.astro";

export async function getStaticPaths() {
  const posts = await getPosts({
    includeUnpublished: true,
  });
  return posts.map((p) => ({
    params: {
      post: p.slug,
    },
    props: p,
  }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.params as Params;
const {
  content,
  title: rawTitle,
  tags,
  disqus,
  excerpt,
  image,
  status,
} = Astro.props as Props;

const isDraft = status === "draft";
const className = isDraft ? "draft" : undefined;
const title = isDraft ? `DRAFT: ${rawTitle}` : rawTitle;

const posts = await getPosts();

const postIndex = posts.findIndex((p) => p.slug === post);
const newer = posts[postIndex - 1];
const older = posts[postIndex + 1];

const { extracted, ...imageProps } = image || {};
---

<Layout
  title={title}
  description={excerpt}
  image={image?.src}
  next={newer && {
    title: newer.title,
    url: newer.slug,
  }}
  previous={older && {
    title: older.title,
    url: older.slug,
  }}
>
  <Shadowbox padding={2} class={className}>
    <PostMeta
      post={{
        ...Astro.props,
        title,
      }}
      includeExcerpt={false}
      linkTitle={false}
      Heading="h1"
    />
    {extracted ? undefined : <img class="aligncenter" {...imageProps} />}
    <Typography set:html={content} />
    <Tags tags={tags} />
  </Shadowbox>

  <Shadowbox padding={2}>
    <Comments id={disqus.id} url={disqus.url} />
  </Shadowbox>
</Layout>

<style>
  .draft {
    border: 1rem solid #ff700a;
  }
</style>
