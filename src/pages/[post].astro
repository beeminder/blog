---
import type { InferGetStaticParamsType, InferGetStaticPropsType } from "astro";
import Layout from "../layouts/Layout.astro";
import getPosts from "../lib/getPosts";
import type { Post } from "../lib/makePost";

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((p) => ({
    params: {
      post: p.slug,
    },
    props: p,
  }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.params as Params;
const { content, title, date, author, tags, disqus } = Astro.props as Props;

const posts = await getPosts();

const postIndex = posts.findIndex((p) => p.slug === post);
const newer = posts[postIndex - 1];
const older = posts[postIndex + 1];

const post1 = posts[Math.floor(Math.random() * posts.length)];
const post2 = posts[Math.floor(Math.random() * posts.length)];
const post3 = posts[Math.floor(Math.random() * posts.length)];
const recommendedPosts: Post[] = [post1, post2, post3].filter(
  (p): p is Post => !!p
);
---

<Layout title={title}>
  {newer && (
    <a href={`/${newer.slug}`}>
      <h2 set:html={`« ${newer.title}`} />
    </a>
  )}
  {older && (
    <a href={`/${older.slug}`}>
      <h2 set:html={`${older.title} »`} />
    </a>
  )}
  <h1 set:html={title} />
  <p>{date}</p>
  <p>By {author}</p>
  <a href=`/${post}`>Permalink</a>
  <div set:html={content} />
  <h2>Tags</h2>
  <ul class="tags">
    {
      tags.map((t) => (
        <li>
          <a href={`/tags/${t}`}>{t}</a>
        </li>
      ))
    }
  </ul>
  <h2>Recommended Posts</h2>
  <ul>
    {
      recommendedPosts.map((p) => (
        <li>
          <a href={`/${p.slug}`} set:html={p.title} />
        </li>
      ))
    }
  </ul>
  <h2>Comments</h2>
  <div id="disqus_thread" data-url={disqus.url} data-identifier={disqus.id}></div>
</Layout>

<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    
    // @ts-ignore - disqus_config is a global function
    var disqus_config = function (this: any) {
      const thread = document.getElementById("disqus_thread");
      if (!thread) throw new Error('could not find disqus thread');
      this.page.url = thread.dataset.url;
      this.page.identifier = thread.dataset.identifier;
      console.log({ url: this.page.url, identifier: this.page.identifier })
    };
    
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://beemblog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', String(+new Date()));
      (d.head || d.body).appendChild(s);
    })();
</script>